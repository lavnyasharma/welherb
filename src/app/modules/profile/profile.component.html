<div class="profile-page">
  <!-- Floating Sidebar Navigation -->
  <div class="sidebar-floating">
    <div
      class="sidebar-item"
      [class.active]="activeTab === TAB_PROFILE"
      (click)="selectTab(TAB_PROFILE)"
    >
      <i class="pi pi-user"></i>
      <span>My Profile</span>
    </div>

    <div
      class="sidebar-item"
      [class.active]="activeTab === TAB_ORDERS"
      (click)="selectTab(TAB_ORDERS)"
    >
      <i class="pi pi-file"></i>
      <span>Orders</span>
    </div>

    <!-- Switch Profile Toggle (Matches other items) -->
    <div
      class="sidebar-item"
      (click)="toggleSwitchProfile()"
      [class.expanded-toggle]="isSwitchProfileExpanded"
    >
      <i class="pi pi-sort-alt"></i>
      <span>Switch Profile</span>
      <i
        class="pi pi-chevron-down ml-auto"
        [class.rotate-180]="isSwitchProfileExpanded"
        style="font-size: 12px; margin-left: auto"
      ></i>
    </div>

    <!-- Profile List (Accordion Content) -->
    <div class="sidebar-profile-list" *ngIf="isSwitchProfileExpanded">
      <div
        class="sidebar-profile-item"
        *ngFor="let profile of savedProfiles"
        (click)="switchToProfile(profile)"
        [class.active]="profile.id === profileData.id"
      >
        {{ profile.name }}
      </div>
    </div>

    <div class="sidebar-item" (click)="openAddMoreModal()">
      <i class="pi pi-plus-circle"></i>
      <span>Add More</span>
    </div>

    <div class="sidebar-item" (click)="logout()">
      <i class="pi pi-sign-out"></i>
      <span>Logout</span>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Profile Tab -->
    <div *ngIf="activeTab === TAB_PROFILE" class="content-section">
      <div class="profile-header">
        <div class="profile-title-wrapper">
          <h2 style="font-family: lato, sans-serif !important">My Profile</h2>
        </div>
        <div class="avatar-upload">
          <div class="profile-avatar">
            <img
              [src]="selectedProfile?.avatar || 'assets/dummy-avatar.png'"
              alt="Profile"
            />
            <div class="camera-icon" (click)="openImageUpload()">
              <i
                class="pi pi-camera"
                style="color: #1b5e20; font-size: 1.2rem"
              ></i>
            </div>
          </div>
        </div>
      </div>

      <!-- For Personalised Dosage Section -->
      <div class="personalized-section">
        <h3 style="font-family: lato, sans-serif !important">
          For Personalised Dosage:
        </h3>
        <div class="dosage-row">
          <div class="dosage-field">
            <span class="dosage-label">Gender</span>
            <p-dropdown
              [options]="genderOptions"
              [(ngModel)]="selectedGender"
              optionLabel="label"
              optionValue="value"
              placeholder="Select"
              styleClass="dosage-dropdown"
            >
            </p-dropdown>
          </div>
          <div class="dosage-field">
            <span class="dosage-label">Height</span>
            <input
              type="text"
              [(ngModel)]="profileData.height"
              name="height"
              class="dosage-input"
              placeholder=""
            />
          </div>
          <div class="dosage-field">
            <span class="dosage-label">Weight</span>
            <input
              type="text"
              [(ngModel)]="profileData.weight"
              name="weight"
              class="dosage-input"
              placeholder=""
            />
          </div>
        </div>
      </div>

      <form
        class="profile-form"
        (ngSubmit)="saveChanges()"
        #profileForm="ngForm"
      >
        <div class="form-section-title">Personal Info:</div>

        <div class="form-row-horizontal">
          <label class="form-label">Name</label>
          <input
            type="text"
            [(ngModel)]="profileData.fullName"
            name="fullName"
            class="form-input"
            placeholder="Chandani Kapoor"
          />
        </div>

        <div class="form-row-horizontal">
          <label class="form-label">Address</label>
          <div class="input-with-icon">
            <input
              type="text"
              [(ngModel)]="profileData.address"
              name="address"
              class="form-input"
              placeholder="Street 09, Banur, Mohali, 42 Chandigarh, India-132912"
            />
            <i class="pi pi-chevron-down input-icon"></i>
          </div>
        </div>

        <div class="form-row-horizontal">
          <label class="form-label">Phone</label>
          <input
            type="tel"
            [(ngModel)]="profileData.phone"
            name="phone"
            class="form-input"
            placeholder="9387472342"
          />
        </div>

        <div class="form-row-horizontal">
          <label class="form-label">Email</label>
          <input
            type="email"
            [(ngModel)]="profileData.email"
            name="email"
            class="form-input"
            placeholder="@welherb.com"
          />
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="btn-secondary"
            (click)="openDeleteModal()"
          >
            Delete Profile
          </button>
          <button type="submit" class="btn-primary">Save Changes</button>
        </div>
      </form>
    </div>

    <!-- Orders Tab -->
    <div *ngIf="activeTab === TAB_ORDERS" class="content-section">
      <h2 style="font-family: lato, sans-serif !important">All Orders</h2>

      <div *ngIf="isLoadingOrders" class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading orders...</p>
      </div>

      <div *ngIf="!isLoadingOrders && orders.length === 0" class="no-orders">
        <p>No orders found</p>
      </div>

      <div *ngIf="!isLoadingOrders && orders.length > 0" class="orders-list">
        <div
          class="order-item"
          *ngFor="let order of orders"
          (click)="viewOrderDetails(order)"
        >
          <div class="order-thumbnail"></div>
          <div class="order-info">
            <div class="order-id">
              <span
                >Order ID:
                {{ order.orderId || order.order_id || order._id }}</span
              >
              <svg
                width="15"
                height="15"
                viewBox="0 0 15 15"
                fill="none"
                class="copy-icon"
                (click)="
                  $event.stopPropagation();
                  copyOrderId(order.orderId || order.order_id || order._id)
                "
              >
                <path
                  d="M4.5 4.5H10.5C11.6046 4.5 12.5 5.39543 12.5 6.5V12.5C12.5 13.6046 11.6046 14.5 10.5 14.5H4.5C3.39543 14.5 2.5 13.6046 2.5 12.5V6.5C2.5 5.39543 3.39543 4.5 4.5 4.5Z"
                  stroke="currentColor"
                  stroke-width="1.2"
                />
                <path
                  d="M4.5 4.5V2.5C4.5 1.39543 5.39543 0.5 6.5 0.5H12.5C13.6046 0.5 14.5 1.39543 14.5 2.5V8.5C14.5 9.60457 13.6046 10.5 12.5 10.5H10.5"
                  stroke="currentColor"
                  stroke-width="1.2"
                />
              </svg>
            </div>
            <div class="order-date-left">{{ formatDate(order.createdAt) }}</div>
            <div class="order-meta">
              <span
                >₹{{
                  order.payment_amount?.total_amount || order.totalAmount || 0
                }}</span
              >
              <span> | </span>
              <span>{{ order.products?.length || 0 }} Items</span>
            </div>
          </div>
          <div class="order-status">
            <div class="status-text">{{ getOrderStatus(order.status) }}</div>
            <div class="status-date">{{ formatDate(order.createdAt) }}</div>
          </div>
          <svg
            class="chevron-right"
            width="8"
            height="14"
            viewBox="0 0 8 14"
            fill="none"
          >
            <path
              d="M1 1L7 7L1 13"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </div>
      </div>
    </div>

    <!-- Order Details View -->
    <div
      *ngIf="activeTab === TAB_ORDER_DETAILS && selectedOrder"
      class="content-section-transparent order-details-view"
    >
      <!-- 1. Order Status Card -->
      <div class="card order-status-card">
        <div class="card-header-row">
          <div class="header-left-group">
            <!-- Order Image (Random/First Product) -->
            <div class="order-main-image">
              <img
                *ngIf="selectedOrder.products?.[0]?.product?.default_image"
                [src]="selectedOrder.products?.[0]?.product?.default_image"
                alt="Product"
              />
              <div
                *ngIf="!selectedOrder.products?.[0]?.product?.default_image"
                class="image-placeholder"
              ></div>
            </div>

            <!-- Order Info & Actions -->
            <div class="header-info-wrapper">
              <div class="order-id-row">
                <h3 style="font-family: lato, sans-serif !important">
                  Order ID:
                  {{ selectedOrder.orderId || selectedOrder.order_id }}
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 14 14"
                    fill="none"
                    class="copy-icon-small"
                    (click)="
                      $event.stopPropagation();
                      copyOrderId(
                        selectedOrder.orderId || selectedOrder.order_id
                      )
                    "
                  >
                    <path
                      d="M3.5 3.5H9.5C10.6046 3.5 11.5 4.39543 11.5 5.5V11.5C11.5 12.6046 10.6046 13.5 9.5 13.5H3.5C2.39543 13.5 1.5 12.6046 1.5 11.5V5.5C1.5 4.39543 2.39543 3.5 3.5 3.5Z"
                      stroke="#999"
                      stroke-width="1.2"
                    />
                    <path
                      d="M3.5 3.5V1.5C3.5 0.39543 4.39543 -0.5 5.5 -0.5H11.5C12.6046 -0.5 13.5 0.39543 13.5 1.5V7.5C13.5 8.60457 12.6046 9.5 11.5 9.5H9.5"
                      stroke="#999"
                      stroke-width="1.2"
                    />
                  </svg>
                </h3>
              </div>
              <div class="order-date-track">
                <span class="date-text">{{
                  formatDate(selectedOrder.createdAt)
                }}</span>
                <span class="track-text"
                  >Track:
                  {{
                    selectedOrder.trackingId || selectedOrder.shipping_id
                  }}</span
                >
              </div>

              <button
                class="btn-cancel-outline"
                *ngIf="
                  selectedOrder.status === 'pending' ||
                  selectedOrder.status === 'Ordered' ||
                  selectedOrder.status === 'confirmed'
                "
              >
                Cancel Order
              </button>
            </div>
          </div>

          <div class="header-right-col">
            <span
              class="status-badge large"
              [ngClass]="getStatusClass(selectedOrder.status)"
            >
              {{ getOrderStatus(selectedOrder.status) }}
            </span>
            <div class="header-date-right">
              {{ formatDate(selectedOrder.createdAt) }}
            </div>
          </div>
        </div>

        <div class="action-row" style="display: none"></div>

        <!-- Order Progress -->
        <div class="order-progress-container">
          <div
            class="progress-step-square"
            [class.completed]="
              isStepCompleted('confirmed', selectedOrder.status)
            "
          >
            <div class="step-box">
              <i
                class="pi pi-check"
                *ngIf="isStepCompleted('confirmed', selectedOrder.status)"
              ></i>
            </div>
            <span class="step-label">Confirmed</span>
          </div>

          <div
            class="progress-line-dashed"
            [class.completed]="isStepCompleted('transit', selectedOrder.status)"
          ></div>

          <div
            class="progress-step-square"
            [class.completed]="isStepCompleted('transit', selectedOrder.status)"
          >
            <div class="step-box">
              <i
                class="pi pi-check"
                *ngIf="isStepCompleted('transit', selectedOrder.status)"
              ></i>
            </div>
            <span class="step-label">In Transit</span>
          </div>

          <div
            class="progress-line-dashed"
            [class.completed]="
              isStepCompleted('delivery', selectedOrder.status)
            "
          ></div>

          <div
            class="progress-step-square"
            [class.completed]="
              isStepCompleted('delivery', selectedOrder.status)
            "
          >
            <div class="step-box">
              <i
                class="pi pi-check"
                *ngIf="isStepCompleted('delivery', selectedOrder.status)"
              ></i>
            </div>
            <span class="step-label">Out for delivery</span>
          </div>

          <div
            class="progress-line-dashed"
            [class.completed]="selectedOrder.status === 'delivered'"
          ></div>

          <div
            class="progress-step-square"
            [class.completed]="selectedOrder.status === 'delivered'"
          >
            <div class="step-box">
              <i
                class="pi pi-check"
                *ngIf="selectedOrder.status === 'delivered'"
              ></i>
            </div>
            <span class="step-label">Delivered</span>
          </div>
        </div>
      </div>

      <!-- 2. Order Summary Card -->
      <div class="card order-summary-card">
        <h4 style="font-family: lato, sans-serif !important">
          Order Summary ({{ selectedOrder.products?.length || 0 }} items)
        </h4>
        <div class="order-items-list-details">
          <div
            class="summary-item-detail"
            *ngFor="let item of selectedOrder.products"
          >
            <div class="item-image-placeholder-large"></div>
            <div class="item-info-detail">
              <div class="item-name-large">
                {{ item.product?.name || "ESR Count" }}
              </div>
              <div class="item-meta-detail">
                <span class="meta-label">Size:</span>
                {{ item.product?.size || "60 Tabs" }}
                <span class="meta-separator">Qty:</span>
                {{ item.count || item.quantity || 1 }}
              </div>
            </div>
            <div class="item-price-detail">
              <div class="current-price">
                ₹{{ item.product?.price || item.product?.mrp || 349 }}
              </div>
              <div class="original-price" *ngIf="item.product?.originalPrice">
                ₹{{ item.product?.originalPrice }}
              </div>
            </div>
          </div>
        </div>

        <div class="order-totals-section">
          <div class="total-row">
            <span class="label">Sub Total:</span>
            <span class="value"
              >₹{{ selectedOrder.payment_amount?.product_amount || 0 }}</span
            >
          </div>
          <div class="total-row">
            <span class="label">Discount:</span>
            <span class="value"
              >₹{{
                (selectedOrder.payment_amount?.product_amount || 0) -
                  (selectedOrder.payment_amount?.total_amount || 0)
              }}</span
            >
          </div>
          <div class="total-row">
            <span class="label">Shipping Charges:</span>
            <span class="value"
              >₹{{ selectedOrder.payment_amount?.delivery_amount || 0 }}</span
            >
          </div>
          <div class="total-row highlight-green">
            <span class="label">Total Savings:</span>
            <span class="value"
              >₹{{
                (selectedOrder.payment_amount?.product_amount || 0) -
                  (selectedOrder.payment_amount?.total_amount || 0)
              }}</span
            >
          </div>
          <div class="grand-total-row">
            <span class="label">Grand Total</span>
            <span class="value"
              >₹{{ selectedOrder.payment_amount?.total_amount || 0 }}</span
            >
          </div>
          <div class="tax-note">(Inclusive of all taxes)</div>
        </div>
      </div>

      <!-- 3. Personal Details Card -->
      <div class="card personal-details-card">
        <h4 style="font-family: lato, sans-serif !important">
          Personal Details
        </h4>
        <div class="details-grid">
          <div class="detail-group">
            <span class="detail-label">Name:</span>
            <span class="detail-value">{{ selectedOrder.address?.name }}</span>
          </div>
          <div class="detail-group">
            <span class="detail-label">Shipping address:</span>
            <span class="detail-value">
              {{ selectedOrder.address?.address }},
              {{ selectedOrder.address?.city }},
              {{ selectedOrder.address?.state }} -
              {{ selectedOrder.address?.pincode }}
            </span>
          </div>
          <div class="detail-group">
            <span class="detail-label">Billing address:</span>
            <span class="detail-value">
              {{ selectedOrder.address?.address }},
              {{ selectedOrder.address?.city }},
              {{ selectedOrder.address?.state }} -
              {{ selectedOrder.address?.pincode }}
            </span>
          </div>
          <div class="detail-group">
            <span class="detail-label">Phone:</span>
            <span class="detail-value">{{
              selectedOrder.address?.mobile || selectedOrder.address?.phone
            }}</span>
          </div>
          <div class="detail-group">
            <span class="detail-label">Email:</span>
            <span class="detail-value">{{ selectedOrder.address?.email }}</span>
          </div>
          <div class="detail-group">
            <span class="detail-label">Payment:</span>
            <span class="detail-value">{{
              selectedOrder.order_type || "Online"
            }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add More Modal -->
  <div
    class="modal-overlay"
    *ngIf="showAddMoreModal"
    (click)="closeAddMoreModal()"
  >
    <div
      class="modal-content profile-form-modal"
      (click)="$event.stopPropagation()"
    >
      <div class="modal-header">
        <h3>Add New Profile</h3>
        <button class="close-btn" (click)="closeAddMoreModal()">×</button>
      </div>

      <div class="modal-body" style="padding-bottom: 0; padding-top: 10px;">
        <!-- Section 1: Dosage -->
        <div class="form-section dosage-section-modal">
          <h4 style="font-family: lato, sans-serif !important">Fill to get your personailsed dosage:</h4>
          <div class="dosage-row-inline">
            <div class="dosage-field">
              <span class="label">Gender</span>
              <div class="custom-select-wrapper">
                <select
                  [(ngModel)]="newAddress.gender"
                  name="gender"
                  class="dosage-select"
                >
                  <option value="">Select</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
                <i class="pi pi-chevron-down select-icon"></i>
              </div>
            </div>
            <div class="dosage-field">
              <span class="label">Height</span>
              <input
                type="number"
                [(ngModel)]="newAddress.height"
                name="height"
                class="dosage-input"
              />
            </div>
            <div class="dosage-field">
              <span class="label">Weight</span>
              <input
                type="number"
                [(ngModel)]="newAddress.weight"
                name="weight"
                class="dosage-input no-border"
                placeholder="Weight"
              />
            </div>
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- Section 2: Personal Info -->
        <div class="form-section personal-info-section">
          <h4 style="font-family: lato, sans-serif !important">Add personal info*</h4>

          <!-- Name -->
          <div class="form-row">
            <input
              type="text"
              [(ngModel)]="newAddress.name"
              name="name"
              placeholder="Name*"
              class="full-width-input"
            />
          </div>

          <!-- Phone & Email -->
          <div class="form-row-grid">
            <input
              type="tel"
              [(ngModel)]="newAddress.phone"
              name="phone"
              placeholder="Phone Number*"
            />
            <input
              type="email"
              [(ngModel)]="newAddress.email"
              name="email"
              placeholder="Email(Optional)"
            />
          </div>

          <!-- Address -->
          <div class="form-row">
            <textarea
              [(ngModel)]="newAddress.address"
              name="address"
              placeholder="Address*(Flat/House number/Street)"
              rows="3"
              class="full-width-input"
            ></textarea>
          </div>

          <!-- Area & Landmark -->
          <div class="form-row-grid">
            <input
              type="text"
              [(ngModel)]="newAddress.area"
              name="area"
              placeholder="Area(Optional)"
            />
            <input
              type="text"
              [(ngModel)]="newAddress.landmark"
              name="landmark"
              placeholder="Landmark(Optional)"
            />
          </div>

          <!-- Pin & City -->
          <div class="form-row-grid">
            <input
              type="text"
              [(ngModel)]="newAddress.pincode"
              name="pincode"
              placeholder="Pin Code*"
              maxlength="6"
            />
            <input
              type="text"
              [(ngModel)]="newAddress.city"
              name="city"
              placeholder="City*"
            />
          </div>
        </div>
      </div>

      <div class="modal-footer no-border">
        <button type="button" class="btn btn-continue" (click)="saveAddress()">
          Continue
        </button>
      </div>
    </div>
  </div>

  <!-- Switch Profile Modal -->
  <div
    class="modal-overlay"
    *ngIf="showSwitchProfileModal"
    (click)="closeSwitchProfileModal()"
  >
    <div
      class="modal-content switch-profile-modal"
      (click)="$event.stopPropagation()"
    >
      <div class="switch-header">
        <i class="pi pi-sort-alt switch-icon"></i>
        <span>Switch Profile</span>
      </div>

      <div class="simple-profile-list">
        <div
          class="simple-profile-item"
          *ngFor="let profile of savedProfiles"
          (click)="switchToProfile(profile)"
          [class.active-profile]="profile.name === profileData.fullName"
        >
          {{ profile.name }}
        </div>
      </div>
    </div>
  </div>

  <!-- Gender Selection Modal -->
  <div
    class="modal-overlay"
    *ngIf="showModal === 'gender'"
    (click)="closeModal()"
  >
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Select Gender</h3>
      <div class="modal-options">
        <button
          class="modal-option"
          [class.active]="selectedGender === 'male'"
          (click)="selectOption('gender', 'male')"
        >
          Male
        </button>
        <button
          class="modal-option"
          [class.active]="selectedGender === 'female'"
          (click)="selectOption('gender', 'female')"
        >
          Female
        </button>
        <button
          class="modal-option"
          [class.active]="selectedGender === 'other'"
          (click)="selectOption('gender', 'other')"
        >
          Other
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div
    class="delete-modal-overlay"
    *ngIf="showDeleteModal"
    (click)="closeDeleteModal()"
  >
    <div class="delete-modal-content" (click)="$event.stopPropagation()">
      <div class="delete-modal-header">
        <h3>Delete Profile</h3>
        <button class="delete-close-btn" (click)="closeDeleteModal()">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M18 6L6 18M6 6L18 18"
              stroke="#666666"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
      <div class="delete-modal-body">
        <p>
          Are you sure you want to delete your profile? This action cannot be
          undone.
        </p>
      </div>
      <div class="delete-modal-actions">
        <button
          type="button"
          class="delete-modal-cancel"
          (click)="closeDeleteModal()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="delete-modal-confirm"
          (click)="confirmDelete()"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
</div>
