<div class="cart-page">
  <!-- Left Side - Cart Items or Order Review -->
  <div class="cart-section">
    <!-- Show Order Review when order is created -->
    <div *ngIf="currentStep === 4 && orderCreated" class="order-review-left">
      <div class="success-header">
        <div class="success-checkmark">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <circle cx="40" cy="40" r="38" fill="#7cb342" stroke="#689f38" stroke-width="2"/>
            <path d="M25 40 L35 50 L55 30" stroke="white" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h2>Thank you!</h2>
        <p>Your order has been placed</p>
        <p class="email-note">We've sent the invoice to your email</p>
      </div>

      <div class="order-details-box">
        <h3>Order Details</h3>
        <div class="detail-row">
          <span>Order number</span>
          <span>{{ selectedOrder?.order_id || selectedOrder?._id || 'whs279027' }}</span>
        </div>
        <div class="detail-row">
          <span>Date</span>
          <span>{{ (selectedOrder?.createdAt ? (selectedOrder?.createdAt | date:'mediumDate') : '') || 'June 27, 2025' }}</span>
        </div>
        <div class="detail-row">
          <span>Payment Method</span>
          <span>{{ selectedPaymentMethod === 'googlepay' ? 'Google Pay' : (selectedOrder?.order_type === 'COD' ? 'Cash On Delivery' : 'Pre-Paid') }}</span>
        </div>
        <div class="detail-divider"></div>
        <div class="detail-row subtotal">
          <span>MRP</span>
          <span>‚Çπ{{ selectedOrder?.payment_amount?.product_amount || mrpTotal }}</span>
        </div>
        <div class="detail-row">
          <span>Shipping</span>
          <span>‚Çπ{{ selectedOrder?.payment_amount?.delivery_amount || shipping }}</span>
        </div>
        <div class="detail-row total">
          <span>Grand Total</span>
          <span>‚Çπ{{ selectedOrder?.payment_amount?.total_amount || grandTotal }}</span>
        </div>
        <div class="tax-note">(Inclusive of all taxes)</div>
      </div>

      <div class="products-box">
        <h3>Products</h3>
        <div class="product-list-item" *ngFor="let item of selectedOrder?.products || cartItems">
          <span *ngIf="selectedOrder?.products">{{ item.count }}x {{ item.product?.name || 'Sugaright' }}</span>
          <span *ngIf="!selectedOrder?.products">{{ item.quantity }}x {{ item.name }}</span>
          <span *ngIf="selectedOrder?.products">‚Çπ{{ (item.product?.price ? item.product.price[30] : 0) * item.count }}</span>
          <span *ngIf="!selectedOrder?.products">‚Çπ{{ item.price * item.quantity }}</span>
        </div>
      </div>

      <div class="customer-details-box">
        <h3>Customer Details</h3>
        <div class="detail-group">
          <strong>Contact</strong>
          <p>{{ selectedOrder?.address?.email || selectedAddress?.email || 'mange@gmail.com' }}</p>
          <p>{{ (selectedOrder?.address?.mobile ? (selectedOrder?.address?.mobile | slice:0:10) : '') || (selectedAddress?.phone ? (selectedAddress?.phone | slice:0:10) : '') || '9876543210' }}</p>
        </div>
        <div class="detail-group">
          <strong>Billing Address</strong>
          <p>{{ selectedOrder?.address?.name || selectedAddress?.name || 'Jitendra Kumar' }}</p>
          <p>{{ selectedOrder?.address?.address || selectedAddress?.address || 'Old Route, 160054, Chandigarh, India' }}</p>
        </div>
      </div>
    </div>

    <!-- Show Cart Items when order is not created or not in step 4 -->
    <div *ngIf="!(currentStep === 4 && orderCreated)" class="cart-items-section">
      <div class="cart-header">
        <h2>My Cart({{ totalItems }})</h2>
      </div>

      <div class="cart-items">
        <div *ngIf="cartItems.length === 0" class="empty-cart">
          <div class="empty-icon">üõçÔ∏è</div>
          <h3>Your cart is empty</h3>
          <p>Add some products to get started</p>
        </div>

        <div class="cart-item" *ngFor="let item of cartItems">
          <img class="item-image" [src]="item.image" [alt]="item.name" />
          
          <div class="item-details">
            <div class="item-header">
              <div class="item-info-left">
                <h3 class="item-name">{{ item.name }}</h3>
                <p class="item-size">Size: {{ item.size }}</p>
              </div>
              <button class="remove-btn" (click)="removeItem(item.id)">Remove</button>
            </div>
            
            <div class="item-footer">
              <div class="quantity-controls">
                <button 
                  class="quantity-btn minus" 
                  (click)="decreaseQuantity(item.id)"
                  [disabled]="item.quantity <= 1">
                  -
                </button>
                <span class="quantity">{{ item.quantity }}</span>
                <button 
                  class="quantity-btn plus" 
                  (click)="increaseQuantity(item.id)">
                  +
                </button>
              </div>
              <div class="item-price">‚Çπ{{ item.price }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="order-summary" *ngIf="cartItems.length > 0">
        <div class="summary-row">
          <span>MRP</span>
          <span>‚Çπ{{ mrpTotal }}</span>
        </div>
        
        <div class="summary-row">
          <span>Discount</span>
          <span>‚Çπ{{ discount }}</span>
        </div>
        
        <div class="summary-row">
          <span>Shipping</span>
          <span>‚Çπ{{ shipping }}</span>
        </div>
        
        <div class="free-delivery" *ngIf="shipping === 0">
          Free delivery above ‚Çπ499
        </div>
        
        <hr class="summary-divider">
        
        <div class="summary-total">
          <span>Grand Total</span>
          <span>‚Çπ{{ grandTotal }}</span>
        </div>
        
        <div class="summary-note">(inclusive of all taxes)</div>
        
        <div class="savings-badge" *ngIf="savings > 0">
          üéØ You saved ‚Çπ{{ savings }} on this order!
        </div>
      </div>
    </div>
  </div>

  <!-- Right Side - Checkout Container -->
  <div class="checkout-container">
    <div class="checkout-header">
      <h2>Check out</h2>
      <div class="step-progress">
        <div class="step-item" [ngClass]="{ active: currentStep >= 1, current: currentStep === 1 }">
          <div class="step-number">01</div>
          <div class="step-title">Offers</div>
        </div>
        <div class="step-item" [ngClass]="{ active: currentStep >= 2, current: currentStep === 2 }">
          <div class="step-number">02</div>
          <div class="step-title">Delivery</div>
        </div>
        <div class="step-item" [ngClass]="{ active: currentStep >= 3, current: currentStep === 3 }">
          <div class="step-number">03</div>
          <div class="step-title">Payment</div>
        </div>
        <div class="step-item" [ngClass]="{ active: currentStep >= 4, current: currentStep === 4 }">
          <div class="step-number">04</div>
          <div class="step-title">Review</div>
        </div>
      </div>
    </div>

    <div class="checkout-content">
      <!-- Step 1: Offers -->
      <div *ngIf="currentStep === 1" class="step-content">
        <div class="offers-section">
          <div class="coupons-header">
            <i class="icon-coupon">üéüÔ∏è</i>
            <span>Coupons and offers</span>

          </div>
          
          <div class="discount-input">
            <input type="text" 
                   [(ngModel)]="discountCode"
                   placeholder="Discount code or gift card">
            <button class="apply-btn" (click)="applyDiscount()">Apply</button>
          </div>
        </div>
      </div>

      <!-- Step 2: Delivery -->
      <div *ngIf="currentStep === 2" class="step-content">
        <div class="delivery-section">
          <div class="delivery-header">
            <h3>Delivery address</h3>
          </div>
          
          <div class="address-options">
            <div class="address-item" 
                 *ngFor="let address of deliveryAddresses"
                 [class.selected]="address.selected"
                 [class.default-address]="address.address === 'Please add your delivery address below'"
                 (click)="selectAddress(address.id)">
              <input type="radio" 
                     [checked]="address.selected"
                     [value]="address.id">
              <div class="address-details">
                <div *ngIf="address.address === 'Please add your delivery address below'" class="default-address-message">
                  <strong>{{ address.name }}</strong>
                  <p>{{ address.address }}</p>
                  <small>Use the form below to add your actual delivery address</small>
                </div>
                <div *ngIf="address.address !== 'Please add your delivery address below'" class="real-address">
                
                  <div class="address-body">
                    <p class="address-line">{{ address.address }}</p>
                    <p class="address-location">{{ address.city }}, {{ address.state }} - {{ address.pincode }}</p>
              
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="add-new-address">
            <h4>Add new delivery address</h4>
            
            <div *ngIf="pincodeResponse" class="pincode-response">
              <div class="response-success" *ngIf="pincodeResponse.available">
                ‚úÖ Delivery available in your area!
                <div class="response-details">
                  <span *ngIf="pincodeResponse.city">City: {{ pincodeResponse.city }}</span>
                  <span *ngIf="pincodeResponse.state">State: {{ pincodeResponse.state }}</span>
                  <span *ngIf="pincodeResponse.deliveryTime">Delivery Time: {{ pincodeResponse.deliveryTime }}</span>
                </div>
              </div>
              <div class="response-error" *ngIf="!pincodeResponse.available">
                ‚ùå Delivery not available in this pincode area
              </div>
            </div>
            
            <div class="form-row">
              <input type="email" 
                     [(ngModel)]="newAddress.email"
                     placeholder="Email(Optional)">
            </div>
            
            <div class="form-row">
              <input type="text" 
                     [(ngModel)]="newAddress.pincode"
                     placeholder="Pincode*">
              <button class="check-btn" (click)="checkPincode()">Check</button>
            </div>
            
            <div class="form-row">
              <input type="text" 
                     [(ngModel)]="newAddress.name"
                     placeholder="Name*">
              <input type="tel" 
                     [(ngModel)]="newAddress.phone"
                     (input)="onMobileNumberChange(); formatMobileNumber()"
                     (keypress)="validateMobileNumberInput($event)"
                     maxlength="10"
                     placeholder="Phone Number*">
            </div>
            
            <div class="form-row">
              <textarea [(ngModel)]="newAddress.address"
                       placeholder="Address*(Flat/House number/Street)"
                       rows="3"></textarea>
            </div>
            
            <div class="form-row">
              <input type="text" 
                     [(ngModel)]="newAddress.state"
                     placeholder="State">
              <input type="text" 
                     [(ngModel)]="newAddress.city"
                     placeholder="City/District/Town*">
            </div>
            
            <div class="address-actions">
              <button class="add-address-btn" 
                      (click)="addNewAddress()"
                      [disabled]="isAddingAddress">
                {{ isAddingAddress ? 'Adding...' : 'Add Address' }}
              </button>
              <button class="update-address-btn" 
                      (click)="updateAddress()"
                      [disabled]="isUpdatingAddress">
                {{ isUpdatingAddress ? 'Updating...' : 'Update Selected Address' }}
              </button>
            </div>
          </div>

          <!-- COD Checkbox -->
          <div class="cod-checkbox">
            <label>
              <input type="checkbox" 
                     [(ngModel)]="isCODSelected">
              Cash On Delivery (COD)
            </label>
          </div>
        </div>
      </div>

      <!-- Step 3: Payment -->
      <div *ngIf="currentStep === 3" class="step-content">
        <div class="payment-section">
          <div class="payment-group">
            <h4>Recommended Payment Option</h4>
            <div class="payment-option recommended" *ngIf="paymentLinks" (click)="openPaymentLink('gpay')">
              <span>Google Pay</span>
              <img class="payment-logo" src="assets/payment/gpay.svg" alt="GPay" />
            </div>
          </div>

          <div class="payment-group">
            <h4>Online Payment Option</h4>
            <div class="payment-option" *ngIf="paymentLinks" (click)="openPaymentLink('bhim')">
              <span>UPI (Pay via any App)</span>
            
            </div>
            <div class="payment-option" *ngIf="paymentLinks" (click)="openPaymentLink('web')">
              <span>Debit/Credit Card</span>
             
            </div>
            <div class="payment-option" *ngIf="paymentLinks" (click)="openPaymentLink('web')">
              <span>EMI</span>

            </div>
          </div>

          <div class="payment-group">
            <h4>Other</h4>
            <label class="payment-option">
              <input type="radio" name="otherPay" (change)="isCODSelected = true" />
              <span>Cash On Delivery</span>
              <i class="icon-info">üí¨</i>
            </label>
          </div>

          <div class="payment-note">
            <p>You will be redirected to the payment gateway to complete your purchase.</p>
          </div>
        </div>
      </div>

      <!-- Step 4: Survey/FAQs -->
      <div *ngIf="currentStep === 4 && !orderCreated" class="step-content">
        <div class="survey-section">
          <div class="offer-banner">
            <h3>Tell us and get <span class="highlight">10% OFF</span> on your next order!</h3>
          </div>

          <div class="survey-question">
            <h4>How did you first hear about us? <span class="expand-icon">+</span></h4>
            <div class="checkbox-group">
              <label *ngFor="let option of hearAboutOptions">
                <input type="checkbox" 
                       [value]="option"
                       (change)="onHearAboutUsChange(option, $event)">
                {{ option }}
              </label>
            </div>
          </div>

          <div class="survey-question">
            <h4>What made you decide to place the order today? <span class="expand-icon">+</span></h4>
            <textarea [(ngModel)]="orderReason"
                     placeholder="Tell us about your decision..."
                     rows="4"></textarea>
          </div>
        </div>
      </div>

      <!-- Order Success - Show Feedback Form Here -->
      <div *ngIf="orderCreated" class="step-content">
        <div class="feedback-section">
          <h3>We'd Love Your Feedback!</h3>
          <p>Help us improve by sharing your experience</p>
          
          <form class="feedback-form" (ngSubmit)="submitFeedback()">
            <div class="form-group">
              <label>How did you first hear about us?</label>
              <div class="checkbox-group">
                <label *ngFor="let option of hearAboutOptions">
                  <input type="checkbox" 
                         [value]="option"
                         (change)="onHearAboutUsChange(option, $event)">
                  {{ option }}
                </label>
              </div>
            </div>
            
            <div class="form-group">
              <label>What made you decide to place the order today?</label>
              <textarea [(ngModel)]="orderReason"
                       name="orderReason"
                       placeholder="Tell us about your decision..."
                       rows="4"></textarea>
            </div>
            
            <button type="submit" class="submit-feedback-btn">Submit Feedback</button>
          </form>
        </div>
      </div>

      <!-- Order Creation Loading -->
      <div *ngIf="isCreatingOrder" class="order-loading">
        <div class="loading-spinner"></div>
        <h3>Creating your order...</h3>
        <p>Please wait while we process your order</p>
      </div>
    </div>

    <!-- Continue/Submit Button -->
    <div class="checkout-footer" *ngIf="!orderCreated">
      <button *ngIf="currentStep < 4" 
              class="continue-btn" 
              (click)="nextStep()"
              [disabled]="isCreatingOrder">
        {{ isCreatingOrder ? 'Processing...' : 'Continue' }}
      </button>
      <button *ngIf="currentStep === 4 && !orderCreated && !isCreatingOrder" 
              class="submit-btn" 
              (click)="submitOrder()">
        Submit
      </button>
    </div>
  </div>
</div>