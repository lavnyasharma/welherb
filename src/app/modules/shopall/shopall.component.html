<div class="heroimage">
  <img
    style="width: 100%"
    src="https://wrijpsiiuvmeqaeklnqi.supabase.co/storage/v1/object/sign/new/flat-lay-phytotherapy-still-life%201%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9jNTNkMmE3MS00ODk1LTRmN2YtYWExYS01ZjA1ZDhlYWE2YTciLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJuZXcvZmxhdC1sYXktcGh5dG90aGVyYXB5LXN0aWxsLWxpZmUgMSAoMSkucG5nIiwiaWF0IjoxNzU2MjkyNjU2LCJleHAiOjg4MTU2MjA2MjU2fQ.rYe2QkPvplrQOqHRdPzvT8C6zVYmcsi3lJZVv64VQig"
    alt=""
  />
</div>
<div class="shop-container">
  <!-- Filter Toggle Header (Desktop) -->
  <div class="desktop-filter-header">
    <button class="filter-toggle-btn" (click)="toggleDesktopFilters()">
      <img
        src="assets/Vector (9).svg"
        alt="Filter"
        style="width: 16px; height: 16px"
      />
      Filter
    </button>
    <div class="view-options">
      <button
        class="view-btn"
        [class.active]="gridView === '2'"
        (click)="setGridView('2')"
        title="2 columns"
      >
        <img src="assets/Group 204.svg" alt="2 Columns" />
      </button>
      <button
        class="view-btn"
        [class.active]="gridView === '3'"
        (click)="setGridView('3')"
        title="3 columns"
      >
        <img src="assets/Group 205.svg" alt="3 Columns" />
      </button>
      <button
        class="view-btn"
        [class.active]="gridView === '4'"
        (click)="setGridView('4')"
        title="4 columns"
      >
        <img src="assets/Group 206.svg" alt="4 Columns" />
      </button>
    </div>
  </div>

  <!-- Mobile Filter Header -->
  <div class="mobile-filter-header">
    <button class="filter-toggle-btn" (click)="toggleMobileFilters()">
      <img
        src="assets/Vector (9).svg"
        alt="Filter"
        style="width: 16px; height: 16px"
      />
      Filters & Sort
      <span class="filter-count" *ngIf="hasActiveFilters()">{{
        getActiveFilterCount()
      }}</span>
    </button>
    <div class="results-count">
      {{ filteredProducts.length }}
      {{ filteredProducts.length === 1 ? "Product" : "Products" }}
    </div>
  </div>

  <!-- Category Navigation -->
  <div class="category-nav">
    <button
      class="category-btn"
      [class.active]="selectedHeaderCategory === 'all'"
      (click)="selectHeaderCategory('all')"
    >
      Shop All
    </button>
    <button
      class="category-btn"
      [class.active]="selectedHeaderCategory === 'esr'"
      (click)="selectHeaderCategory('esr')"
    >
      ESR
    </button>
    <button
      class="category-btn"
      [class.active]="selectedHeaderCategory === 'sugar'"
      (click)="selectHeaderCategory('sugar')"
    >
      Sugar
    </button>
    <button
      class="category-btn"
      [class.active]="selectedHeaderCategory === 'thyroid'"
      (click)="selectHeaderCategory('thyroid')"
    >
      Thyroid
    </button>
    <div class="dropdown" [class.active]="showOthersDropdown">
      <button
        class="category-btn dropdown-toggle"
        (click)="toggleOthersDropdown()"
      >
        Others
        <i class="fa fa-chevron-down"></i>
      </button>
      <div class="dropdown-menu" *ngIf="showOthersDropdown">
        <button class="dropdown-item" (click)="selectHeaderCategory('liver')">
          Liver
        </button>
        <button class="dropdown-item" (click)="selectHeaderCategory('heart')">
          Heart
        </button>
        <button
          class="dropdown-item"
          (click)="selectHeaderCategory('immunity')"
        >
          Immunity
        </button>
      </div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="main-layout">
    <!-- Sidebar with overlay for mobile -->
    <div
      class="sidebar-overlay"
      [class.active]="showMobileFilters"
      (click)="closeMobileFilters()"
    ></div>
    <div
      class="sidebar"
      [class.mobile-active]="showMobileFilters"
      [class.desktop-active]="showDesktopFilters"
    >
      <!-- Always show sidebar in desktop for this design, logic might need adjustment if it was toggle-only before. 
           But assuming we want it always visible like the image. -->

      <div class="sidebar-header" style="margin-bottom: 10px">
        <h3
          style="
            font-family: Lato !important;
            font-size: 16px;
            font-weight: 600;
            color: #555;
          "
        >
          Filter
        </h3>
        <i class="fa fa-chevron-down"></i>
        <!-- The image has "Filter v", suggesting it might be collapsible too, but usually it's a header -->
      </div>

      <!-- By Concern -->
      <div class="filter-group">
        <div class="filter-group-header" (click)="toggleConcern()">
          <span style="font-family: Lato !important">By Concern</span>
          <i
            class="fa"
            [class.fa-chevron-down]="!isConcernExpanded"
            [class.fa-chevron-up]="isConcernExpanded"
          ></i>
        </div>
        <div class="filter-group-content" *ngIf="isConcernExpanded">
          <label class="checkbox-container" *ngFor="let item of concernFilters">
            <input
              type="checkbox"
              [checked]="item.checked"
              (change)="onFilterChange('concern', item.name, $event)"
            />
            <span class="checkmark" [class.active]="item.checked">
              <i
                class="fa fa-check"
                *ngIf="item.checked"
                style="color: white; font-size: 10px"
              ></i>
            </span>
            <span class="filter-label">{{ item.name }}</span>
          </label>
        </div>
      </div>

      <!-- By Benefit -->
      <div class="filter-group">
        <div class="filter-group-header" (click)="toggleBenefit()">
          <span style="font-family: Lato !important">By Benefit</span>
          <i
            class="fa"
            [class.fa-chevron-down]="!isBenefitExpanded"
            [class.fa-chevron-up]="isBenefitExpanded"
          ></i>
        </div>
        <div class="filter-group-content" *ngIf="isBenefitExpanded">
          <label class="checkbox-container" *ngFor="let item of benefitFilters">
            <input
              type="checkbox"
              [checked]="item.checked"
              (change)="onFilterChange('benefit', item.name, $event)"
            />
            <span class="checkmark" [class.active]="item.checked">
              <i
                class="fa fa-check"
                *ngIf="item.checked"
                style="color: white; font-size: 10px"
              ></i>
            </span>
            <span class="filter-label">{{ item.name }}</span>
          </label>
        </div>
      </div>

      <!-- By Categories -->
      <div class="filter-group">
        <div class="filter-group-header" (click)="toggleCategory()">
          <span style="font-family: Lato !important">By Categories</span>
          <i
            class="fa"
            [class.fa-chevron-down]="!isCategoryExpanded"
            [class.fa-chevron-up]="isCategoryExpanded"
          ></i>
        </div>
        <div class="filter-group-content" *ngIf="isCategoryExpanded">
          <label
            class="checkbox-container"
            *ngFor="let item of categorySidebarFilters"
          >
            <input
              type="checkbox"
              [checked]="item.checked"
              (change)="onFilterChange('category', item.name, $event)"
            />
            <span class="checkmark" [class.active]="item.checked">
              <i
                class="fa fa-check"
                *ngIf="item.checked"
                style="color: white; font-size: 10px"
              ></i>
            </span>
            <span class="filter-label">{{ item.name }}</span>
          </label>
        </div>
      </div>

      <!-- Sort By (Keeping existing functionality but styling it to match) -->
      <div class="filter-group">
        <div class="filter-group-header">
          <span style="font-family: Lato !important">Sort By</span>
          <i class="fa fa-chevron-down"></i>
        </div>
        <div class="filter-group-content">
          <label class="checkbox-container">
            <input
              type="checkbox"
              [checked]="selectedSort === 'featured'"
              (change)="selectedSort = 'featured'; sortProducts()"
            />
            <span
              class="checkmark"
              [class.active]="selectedSort === 'featured'"
            ></span>
            <span class="filter-label">Featured</span>
          </label>
          <label class="checkbox-container">
            <input
              type="checkbox"
              [checked]="selectedSort === 'low'"
              (change)="selectedSort = 'low'; sortProducts()"
            />
            <span
              class="checkmark"
              [class.active]="selectedSort === 'low'"
            ></span>
            <span class="filter-label">Best Selling</span>
            <!-- Mapped 'low' to best selling or price? Original code had price. Image has 'Best Selling'. Let's keep existing logic but update label if desired. -->
          </label>
          <label class="checkbox-container">
            <input
              type="checkbox"
              [checked]="selectedSort === 'name'"
              (change)="selectedSort = 'name'; sortProducts()"
            />
            <span
              class="checkmark"
              [class.active]="selectedSort === 'name'"
            ></span>
            <span class="filter-label">Name: A - Z</span>
          </label>
        </div>
      </div>

      <!-- Price Range (Keeping existing) -->
      <div class="filter-group">
        <div class="filter-group-header">
          <span style="font-family: Lato !important">Prize Range</span>
        </div>
        <div class="price-slider-container">
          <div
            class="price-values"
            style="
              display: flex;
              justify-content: space-between;
              font-family: Lato !important;
              font-size: 12px;
              margin-bottom: 5px;
            "
          >
            <span>₹0</span>
            <span>₹5000</span>
          </div>
          <input
            type="range"
            class="price-slider"
            [(ngModel)]="priceRange"
            min="0"
            max="5000"
            step="100"
            (input)="onPriceChange()"
            (change)="filterByPrice()"
            style="width: 100%; accent-color: var(--color-cta)"
          />
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px">
        <button
          (click)="clearAllFilters()"
          style="
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            font-family: Lato !important;
            cursor: pointer;
          "
        >
          Clear
        </button>
        <button
          style="
            flex: 1;
            padding: 8px;
            border: none;
            background: var(--color-cta);
            color: white;
            border-radius: 4px;
            font-family: Lato !important;
            cursor: pointer;
          "
        >
          Apply
        </button>
      </div>
    </div>

    <!-- Apply Filters Button (Mobile) -->
    <div class="mobile-apply-filters">
      <button class="apply-filters-btn" (click)="applyMobileFilters()">
        Apply Filters ({{ filteredProducts.length }})
      </button>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Active Filters Tags -->
      <div class="active-filters" *ngIf="hasActiveFilters()">
        <div class="filter-tags">
          <span class="filter-tag" *ngIf="priceRange < 5000">
            Price: ₹0 - ₹{{ priceRange }}
            <button (click)="clearPriceFilter()">
              <i class="fa fa-times"></i>
            </button>
          </span>
          <span class="filter-tag" *ngFor="let category of selectedCategories">
            {{ category }}
            <button (click)="removeCategory(category)">
              <i class="fa fa-times"></i>
            </button>
          </span>
        </div>
      </div>

      <!-- Results Header -->
      <div class="results-header">
        <h2>Liv Renew</h2>
        <div class="results-count-desktop">
          {{ filteredProducts.length }}
          {{ filteredProducts.length === 1 ? "Product" : "Products" }}
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="isLoading">
        <div class="loading-spinner">
          <div class="simple-spinner"></div>
          <p>Loading products...</p>
        </div>
      </div>

      <!-- No Products Found -->
      <div
        class="no-products"
        *ngIf="!isLoading && filteredProducts.length === 0"
      >
        <div class="no-products-content">
          <i class="fa fa-shopping-bag"></i>
          <h3>No products found</h3>
          <p>Sorry, we couldn't find any products matching your criteria.</p>
          <button
            class="clear-filters-btn"
            (click)="clearAllFilters()"
            *ngIf="hasActiveFilters()"
          >
            <i class="fa fa-refresh"></i>
            Clear All Filters
          </button>
        </div>
      </div>

      <!-- Product Grid -->
      <div
        class="product-grid"
        [class.grid-2]="gridView === '2'"
        [class.grid-3]="gridView === '3'"
        [class.grid-4]="gridView === '4'"
        *ngIf="!isLoading && filteredProducts.length > 0"
      >
        <div
          class="product-card"
          *ngFor="let product of filteredProducts; trackBy: trackProduct"
          [attr.data-product-id]="product.id"
        >
          <!-- Image Container -->
          <div class="image-container" (click)="navigateToProduct(product.id)">
            <img
              [src]="product.image"
              [alt]="product.name"
              class="product-image"
              loading="lazy"
              (error)="onImageError($event)"
            />
          </div>

          <!-- Product Details -->
          <div class="product-details">
            <h3 class="product-name" [title]="product.name">
              {{ product.name }}
            </h3>

            <!-- Category Tags -->
            <div
              class="category-tags"
              *ngIf="product.category && product.category.length > 0"
            >
              <span style="font-family: Lato !important" class="category-tag">
                <ng-container
                  *ngFor="let category of product.category; let last = last"
                >
                  {{ category }}<span *ngIf="!last"> | </span>
                </ng-container>
              </span>
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div class="price-rating-section">
                <div class="price-container">
                  <span
                    style="font-family: Lato !important"
                    class="current-price"
                    >₹{{ product.displayPrice }}</span
                  >
                </div>

                <!-- Rating -->
              </div>
              <div
                class="size-options"
                *ngIf="product.sizes && product.sizes.length > 0"
              >
                <button
                  *ngFor="let size of product.sizes"
                  class="size-btn"
                  [class.active]="size === product.selectedSize"
                  (click)="updatePrice(product, size)"
                  [title]="'Select size ' + size"
                >
                  {{ size }}
                </button>
              </div>
            </div>
            <div class="product-rating">
              <div class="stars">
                <i
                  class="fa fa-star filled"
                  *ngFor="let star of [1, 2, 3, 4, 5]"
                ></i>
              </div>
              <span style="font-family: Lato !important" class="rating-count"
                >{{ product.rating }}/5({{ product.reviewCount || 90 }})</span
              >
            </div>
            <!-- Price and Rating Section -->

            <!-- Size Selection -->
          </div>

          <!-- Add to Cart Section -->
          <div class="cart-section">
            <ng-container *ngIf="cartLoaded; else loadingCart">
              <button
                class="add-to-cart-btn"
                [class.in-cart]="isInCart(product.id)"
                (click)="handleCartAction(product)"
              >
                <img
                  src="assets/Frame 30.svg"
                  alt="Add to cart"
                  class="cart-icon default-icon"
                />
                <img
                  src="assets/Vector (8).svg"
                  alt="Add to cart"
                  class="cart-icon hover-icon"
                />
                <span
                  style="font-family: Lato !important"
                  *ngIf="!isInCart(product.id)"
                  >Add to Cart</span
                >
                <span
                  style="font-family: Lato !important"
                  *ngIf="isInCart(product.id)"
                  >Add to Cart</span
                >
              </button>
            </ng-container>
            <ng-template #loadingCart>
              <button class="add-to-cart-btn loading" disabled>
                <i class="fa fa-spinner fa-spin"></i>
                Loading...
              </button>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Load More Button -->
      <div class="load-more-section" *ngIf="hasMoreProducts && !isLoading">
        <button
          class="load-more-btn"
          (click)="loadMoreProducts()"
          [disabled]="isLoadingMore"
        >
          <i class="fa fa-plus" *ngIf="!isLoadingMore"></i>
          <i class="fa fa-spinner fa-spin" *ngIf="isLoadingMore"></i>
          {{ isLoadingMore ? "Loading..." : "Load More Products" }}
        </button>
      </div>
    </div>
  </div>
</div>
